<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>hola.cloud Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div id="app" class="app-shell" v-cloak>
      <div v-if="user === 'loading'" class="full-screen-state">
        <div class="full-screen-state__content">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p class="full-screen-state__title">Preparando tu consola…</p>
          <p class="full-screen-state__subtitle">
            Verificamos tu sesión para que puedas continuar donde lo dejaste.
          </p>
        </div>
      </div>

      <template v-else>
        <header class="app-header">
          <div class="app-header__brand">
            <img src="img/logo-hola-cloud.svg" alt="hola.cloud" class="app-header__logo" />
            <div class="app-header__brand-text">
              <span class="app-header__brand-title">hola.cloud</span>
              <span class="app-header__brand-subtitle">Console</span>
            </div>
          </div>

          <div v-if="isLoggedIn" class="app-header__project">
            <label class="hc-form-label" for="project-switcher">Proyecto</label>
            <select
              id="project-switcher"
              class="hc-input app-header__project-select"
              v-model="selectedProjectId"
              :disabled="isLoadingProjects"
            >
              <option v-if="isLoadingProjects" disabled>Actualizando proyectos…</option>
              <option
                v-for="project in sortedProjects"
                :key="project.id"
                :value="project.id"
              >
                {{ project.name }}
              </option>
            </select>
          </div>

          <div class="app-header__actions">
            <template v-if="isLoggedIn">
              <div class="user-chip">
                <div class="user-chip__avatar" aria-hidden="true">
                  <img
                    v-if="user.picture"
                    :src="user.picture"
                    alt=""
                    referrerpolicy="no-referrer"
                  />
                  <span v-else>{{ userInitials }}</span>
                </div>
                <div class="user-chip__meta">
                  <span class="user-chip__name">{{ user.nick }}</span>
                  <span v-if="user.email" class="user-chip__email">{{ user.email }}</span>
                </div>
              </div>
              <a href="/auth/logout" class="hc-button hc-btn-secondary">Cerrar sesión</a>
            </template>
            <template v-else>
              <a href="https://hola.cloud/auth/login" class="hc-button">Iniciar sesión</a>
            </template>
          </div>
        </header>

        <main class="app-main">
          <section v-if="!isLoggedIn" class="hero">
            <div class="hero__content hc-card">
              <div class="hero__text">
                <h1 class="hc-heading-1">La nube que te saluda</h1>
                <p class="hc-body hero__subtitle">
                  Controla bases de datos, lambdas y archivos en un entorno unificado con estados en tiempo real.
                </p>
                <div class="hero__actions">
                  <a href="https://hola.cloud/auth/login" class="hc-button">Iniciar sesión</a>
                  <a href="https://hola.cloud" class="hc-button hc-btn-secondary" target="_blank" rel="noopener">Conoce hola.cloud</a>
                </div>
              </div>
              <div class="hero__preview">
                <div class="hero__glow"></div>
                <div class="hero__cards">
                  <div class="hero-card">
                    <span class="hero-card__label">Provisionamiento</span>
                    <span class="hero-card__value">Ágil y seguro</span>
                  </div>
                  <div class="hero-card">
                    <span class="hero-card__label">Integraciones</span>
                    <span class="hero-card__value">+20 servicios</span>
                  </div>
                  <div class="hero-card">
                    <span class="hero-card__label">Latency promedio</span>
                    <span class="hero-card__value">42 ms</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section v-else-if="showEmptyState" class="content-section">
            <div class="hc-card empty-state">
              <div class="empty-state__icon" aria-hidden="true">☁️</div>
              <h2 class="hc-heading-2">Crea tu primer proyecto</h2>
              <p class="hc-body empty-state__text">
                Define un nombre memorable y comienza a desplegar tus recursos en segundos.
              </p>
              <form class="empty-state__form" @submit.prevent="createProject">
                <div class="hc-input-wrapper">
                  <label class="hc-form-label" for="project-name">Nombre del proyecto</label>
                  <input
                    id="project-name"
                    class="hc-input"
                    type="text"
                    autocomplete="off"
                    maxlength="80"
                    placeholder="Ej. api-finanzas"
                    v-model="newProjectName"
                  />
                </div>
                <div class="empty-state__actions">
                  <button class="hc-button" type="submit" :disabled="!newProjectName || loading.createProject">
                    <span v-if="loading.createProject" class="button-spinner" aria-hidden="true"></span>
                    Crear proyecto
                  </button>
                </div>
              </form>
            </div>
          </section>

          <section v-else-if="!selectedProject" class="content-section">
            <div class="project-board">
              <div class="project-board__header">
                <div>
                  <p class="section-eyebrow">Bienvenido de vuelta</p>
                  <h2 class="hc-heading-2">Elige un proyecto para continuar</h2>
                  <p class="hc-body project-board__subtitle">
                    Gestiona tus entornos desde un único panel. Puedes crear proyectos ilimitados para aislar recursos por equipo o producto.
                  </p>
                </div>
                <button class="hc-button hc-btn-secondary" type="button" @click="toggleNewProjectForm">
                  Nuevo proyecto
                </button>
              </div>

              <div class="project-board__grid">
                <article
                  v-for="project in sortedProjects"
                  :key="project.id"
                  class="project-card"
                  role="button"
                  tabindex="0"
                  @click="selectProject(project.id)"
                  @keydown.enter.prevent="selectProject(project.id)"
                >
                  <div class="project-card__header">
                    <h3 class="project-card__title">{{ project.name }}</h3>
                    <span v-if="project.owners && project.owners.length" class="project-card__badge">
                      {{ project.owners.length }} miembros
                    </span>
                  </div>
                  <p class="project-card__id hc-mono">{{ project.id }}</p>
                  <p v-if="project.host" class="project-card__host">
                    <span>Dominio:</span>
                    <a :href="'https://' + project.host" target="_blank" rel="noopener">{{ project.host }}</a>
                  </p>
                </article>

                <button class="project-card project-card--cta" type="button" @click="toggleNewProjectForm">
                  <span class="project-card__cta-icon">＋</span>
                  <span class="project-card__cta-text">Crear nuevo proyecto</span>
                </button>
              </div>

              <transition name="fade-slide">
                <form
                  v-if="showNewProjectForm"
                  class="project-board__form hc-card"
                  @submit.prevent="createProject"
                >
                  <div class="project-board__form-header">
                    <div>
                      <h3 class="hc-heading-3">Nuevo proyecto</h3>
                      <p class="hc-body project-board__form-text">
                        Asigna un nombre único. Podrás agregar miembros y configurar dominios más adelante.
                      </p>
                    </div>
                    <button class="project-board__form-close" type="button" @click="toggleNewProjectForm">
                      Cerrar
                    </button>
                  </div>
                  <div class="hc-input-wrapper">
                    <label class="hc-form-label" for="project-name-inline">Nombre</label>
                    <input
                      id="project-name-inline"
                      class="hc-input"
                      type="text"
                      autocomplete="off"
                      maxlength="80"
                      placeholder="Ej. ecommerce-live"
                      v-model="newProjectName"
                    />
                  </div>
                  <div class="project-board__form-actions">
                    <button class="hc-button" type="submit" :disabled="!newProjectName || loading.createProject">
                      <span v-if="loading.createProject" class="button-spinner" aria-hidden="true"></span>
                      Crear proyecto
                    </button>
                    <button class="hc-button hc-btn-secondary" type="button" @click="toggleNewProjectForm">Cancelar</button>
                  </div>
                </form>
              </transition>
            </div>
          </section>

          <section v-else class="content-section">
            <div class="hc-card workspace-summary">
              <div class="workspace-summary__main">
                <div>
                  <p class="section-eyebrow">Proyecto activo</p>
                  <h1 class="hc-heading-2 workspace-summary__title">{{ selectedProject.name }}</h1>
                  <p class="hc-body workspace-summary__description">
                    Orquesta tus servicios con flujos auditables, métricas en tiempo real y herramientas listas para cada etapa del ciclo de vida.
                  </p>
                </div>
                <div class="workspace-summary__metrics">
                  <div class="metric-card">
                    <span class="metric-card__label">Bases de datos</span>
                    <span class="metric-card__value">{{ tree.databases.length }}</span>
                  </div>
                  <div class="metric-card">
                    <span class="metric-card__label">Lambdas</span>
                    <span class="metric-card__value">{{ tree.lambdas.length }}</span>
                  </div>
                </div>
              </div>
              <div class="workspace-summary__meta">
                <div v-if="projectHost" class="workspace-summary__meta-item">
                  <span class="workspace-summary__meta-label">Dominio público</span>
                  <a :href="projectHost" target="_blank" rel="noopener" class="workspace-summary__meta-value">
                    {{ projectHost.replace('https://', '') }}
                  </a>
                </div>
                <div v-if="selectedProject.owners && selectedProject.owners.length" class="workspace-summary__meta-item">
                  <span class="workspace-summary__meta-label">Colaboradores</span>
                  <div class="workspace-summary__owners">
                    <span
                      v-for="owner in selectedProject.owners"
                      :key="owner.id || owner.email || owner.nick || owner"
                      class="workspace-summary__owner"
                    >
                      {{ owner.nick || owner.email || owner.name || 'Owner' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="workspace" :class="{'workspace--sidebar-hidden': !workspaceSidebarVisible && isCompactLayout}">
              <aside class="workspace__sidebar">
                <div class="workspace__sidebar-header">
                  <h2>Recursos</h2>
                  <button
                    v-if="isCompactLayout"
                    type="button"
                    class="workspace__sidebar-close"
                    @click="workspaceSidebarVisible = false"
                    aria-label="Ocultar panel lateral"
                  >
                    ×
                  </button>
                </div>
                <div class="workspace-tree">
                  <div class="workspace-tree__group">
                    <div class="workspace-tree__title">Bases de datos</div>
                    <div v-if="treeLoading.databases" class="workspace-tree__loading">
                      <span class="loading-spinner loading-spinner--inline" aria-hidden="true"></span>
                      Cargando bases de datos…
                    </div>
                    <template v-else>
                      <p v-if="!tree.databases.length" class="workspace-tree__empty">
                        No hemos detectado bases de datos aún.
                      </p>
                      <div
                        v-for="database in tree.databases"
                        :key="database.id"
                        class="workspace-tree__item"
                      >
                        <button type="button" class="workspace-tree__button" @click="expandDatabase(database)">
                          <span class="workspace-tree__chevron" :class="{'workspace-tree__chevron--open': database.open}"></span>
                          <span class="workspace-tree__label">{{ database.name }}</span>
                          <span class="workspace-tree__meta" v-if="database.collections.length">{{ database.collections.length }}</span>
                        </button>
                        <div v-if="database.open" class="workspace-tree__children">
                          <div v-if="database.collectionsLoading" class="workspace-tree__loading">
                            <span class="loading-spinner loading-spinner--inline" aria-hidden="true"></span>
                            Cargando colecciones…
                          </div>
                          <button
                            v-for="collection in database.collections"
                            :key="database.id + ':' + collection.name"
                            type="button"
                            class="workspace-tree__child"
                            @click="openCollection(database, collection)"
                          >
                            {{ collection.name }}
                          </button>
                        </div>
                      </div>
                    </template>
                  </div>

                  <div class="workspace-tree__group">
                    <div class="workspace-tree__title">Lambdas</div>
                    <div v-if="treeLoading.lambdas" class="workspace-tree__loading">
                      <span class="loading-spinner loading-spinner--inline" aria-hidden="true"></span>
                      Cargando lambdas…
                    </div>
                    <template v-else>
                      <p v-if="!tree.lambdas.length" class="workspace-tree__empty">
                        Integra tu primera lambda para verla aquí.
                      </p>
                      <button
                        v-for="lambda in tree.lambdas"
                        :key="lambda.id"
                        type="button"
                        class="workspace-tree__lambda"
                        @click="openLambda(lambda)"
                      >
                        <span class="workspace-lambda-method" :class="'workspace-lambda-method--' + lambda.method.toLowerCase()">
                          {{ lambda.method }}
                        </span>
                        <span class="workspace-tree__label">{{ lambda.path }}</span>
                      </button>
                    </template>
                  </div>
                </div>
              </aside>

              <div class="workspace__content">
                <div class="workspace__toolbar">
                  <div class="workspace__breadcrumbs">
                    <span class="workspace__breadcrumbs-pill">Proyecto</span>
                    <span class="workspace__breadcrumbs-name">{{ selectedProject.name }}</span>
                  </div>
                  <div class="workspace__toolbar-actions">
                    <button
                      v-if="isCompactLayout"
                      type="button"
                      class="hc-button hc-btn-secondary hc-button--sm"
                      @click="workspaceSidebarVisible = !workspaceSidebarVisible"
                    >
                      {{ workspaceSidebarVisible ? 'Ocultar panel' : 'Mostrar panel' }}
                    </button>
                  </div>
                </div>

                <div class="workspace-tabs">
                  <template v-if="tabs.length">
                    <button
                      v-for="tab in tabs"
                      :key="tab.id"
                      type="button"
                      class="workspace-tab"
                      :class="{'workspace-tab--active': tab.id === activeTabId}"
                      @click="setActiveTab(tab.id)"
                    >
                      <img :src="tab.icon" alt="" class="workspace-tab__icon" />
                      <span class="workspace-tab__label">{{ tab.label }}</span>
                      <button
                        v-if="tab.closable"
                        type="button"
                        class="workspace-tab__close"
                        @click.stop="closeTab(tab.id)"
                        aria-label="Cerrar pestaña"
                      >
                        ×
                      </button>
                    </button>
                  </template>
                  <p v-else class="workspace-tabs__empty">
                    Selecciona un recurso de la izquierda para abrirlo en la consola embebida.
                  </p>
                </div>

                <div class="workspace-frame">
                  <iframe
                    v-for="tab in tabs"
                    :key="tab.id"
                    :src="tab.url"
                    :title="tab.label"
                    v-show="tab.id === activeTabId"
                    loading="lazy"
                    frameborder="0"
                  ></iframe>
                </div>
              </div>
            </div>
          </section>
        </main>
      </template>
    </div>

    <script type="module" src="main.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hola.cloud Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    :root {
      --color-brand: #5666f5;
      --color-brand-50: #f4f6ff;
      --color-brand-100: #e6e9ff;
      --color-brand-200: #c8d0ff;
      --color-brand-300: #a9b6ff;
      --color-brand-400: #899aff;
      --color-brand-500: #5666f5;
      --color-brand-600: #3a4be6;
      --color-brand-700: #2736c2;
      --color-brand-800: #1d2999;
      --color-brand-900: #131c73;

      --color-accent: #ff7a59;
      --color-success: #16a34a;
      --color-warning: #f59e0b;
      --color-danger: #dc2626;
      --color-neutral-50: #f8fafc;
      --color-neutral-100: #f1f5f9;
      --color-neutral-200: #e2e8f0;
      --color-neutral-300: #cbd5f5;
      --color-neutral-400: #94a3b8;
      --color-neutral-500: #64748b;
      --color-neutral-600: #475569;
      --color-neutral-700: #334155;
      --color-neutral-800: #1e293b;
      --color-neutral-900: #0f172a;

      --color-background: var(--color-neutral-50);
      --color-surface: #ffffff;
      --color-surface-elevated: #ffffff;
      --color-surface-muted: rgba(86, 102, 245, 0.05);
      --color-border-subtle: rgba(15, 23, 42, 0.08);
      --color-border-strong: rgba(15, 23, 42, 0.16);
      --color-text-strong: #0f172a;
      --color-text-muted: #475569;
      --color-text-inverse: #f8fafc;
      --focus-ring-color: rgba(86, 102, 245, 0.45);

      --radius-lg: 0.75rem;
      --radius-md: 0.5rem;
      --radius-sm: 0.375rem;

      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 10px 24px rgba(15, 23, 42, 0.16);
      --shadow-lg: 0 16px 48px rgba(15, 23, 42, 0.18);

      color-scheme: light;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--color-background);
      color: var(--color-text-strong);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-neutral-50: #0f172a;
        --color-neutral-100: #172554;
        --color-neutral-200: #1d2a5e;
        --color-neutral-300: #24316a;
        --color-neutral-400: #334072;
        --color-neutral-500: #47536f;
        --color-neutral-600: #64748b;
        --color-neutral-700: #94a3b8;
        --color-neutral-800: #cbd5f5;
        --color-neutral-900: #e2e8f0;

        --color-background: #020617;
        --color-surface: #0b1220;
        --color-surface-elevated: #111c30;
        --color-surface-muted: rgba(86, 102, 245, 0.1);
        --color-border-subtle: rgba(148, 163, 184, 0.2);
        --color-border-strong: rgba(148, 163, 184, 0.28);
        --color-text-strong: #f8fafc;
        --color-text-muted: #cbd5f5;
        --color-text-inverse: #020617;
        --focus-ring-color: rgba(86, 102, 245, 0.45);

        color-scheme: dark;
        background-color: var(--color-background);
        color: var(--color-text-strong);
      }
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      background-color: var(--color-background);
      color: var(--color-text-strong);
    }

    body {
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: var(--color-brand-600);
      text-decoration: none;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
    }

    #app {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }

    .hc-shell {
      display: flex;
      flex: 1;
      background: radial-gradient(circle at top, rgba(86,102,245,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(255,122,89,0.14), transparent 60%),
        var(--color-background);
      color: var(--color-text-strong);
    }

    .hc-sidebar {
      width: 320px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.92) 0%, rgba(15, 23, 42, 0.85) 100%);
      color: var(--color-text-inverse);
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(148, 163, 184, 0.12);
      box-shadow: inset -1px 0 0 rgba(148, 163, 184, 0.08);
    }

    .hc-sidebar--expanded {
      width: 360px;
      box-shadow: inset -1px 0 0 rgba(86, 102, 245, 0.3);
    }

    .hc-sidebar__inner {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .hc-sidebar__header {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hc-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hc-brand img {
      height: 32px;
    }

    .hc-brand__text {
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
    }

    .hc-user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(15, 23, 42, 0.35);
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .hc-user-card img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .hc-user-card__meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hc-user-name {
      font-weight: 600;
    }

    .hc-user-actions a {
      color: rgba(226, 232, 240, 0.9);
      font-weight: 500;
    }

    .hc-sidebar__section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hc-section-title {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.72);
    }

    .hc-select {
      position: relative;
    }

    .hc-select select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.65);
      color: var(--color-text-inverse);
      font-size: 0.95rem;
      appearance: none;
    }

    .hc-select::after {
      content: '\25BC';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.65rem;
      pointer-events: none;
      color: rgba(226, 232, 240, 0.6);
    }

    .hc-tree {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hc-tree-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hc-tree-title {
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.6);
    }

    .hc-tree-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hc-tree-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      color: rgba(226, 232, 240, 0.92);
      background: rgba(148, 163, 184, 0.08);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      border: 1px solid transparent;
    }

    .hc-tree-item:hover {
      background: rgba(86, 102, 245, 0.24);
      border-color: rgba(86, 102, 245, 0.35);
      transform: translateX(2px);
    }

    .hc-tree-item__main {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .hc-tree-item__label {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hc-tree-children {
      margin-left: 18px;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hc-tree-toggle {
      background: transparent;
      border: none;
      color: rgba(226, 232, 240, 0.7);
      cursor: pointer;
      padding: 0;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .hc-tree-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s ease;
    }

    .hc-tree-toggle[aria-expanded="true"] svg {
      transform: rotate(90deg);
    }

    .hc-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.88);
    }

    @media (prefers-color-scheme: dark) {
      .hc-main {
        background: rgba(11, 18, 32, 0.92);
      }
    }

    .hc-main__header {
      padding: 20px 28px 12px;
      border-bottom: 1px solid var(--color-border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .hc-main__breadcrumbs {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hc-main__breadcrumbs span {
      font-size: 0.85rem;
      color: var(--color-neutral-500);
    }

    .hc-main__breadcrumbs strong {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-strong);
    }

    .hc-tabs {
      display: flex;
      align-items: stretch;
      gap: 2px;
      padding: 0 28px;
      background: rgba(86, 102, 245, 0.05);
      border-bottom: 1px solid var(--color-border-subtle);
      flex-wrap: wrap;
    }

    .hc-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border: 1px solid transparent;
      border-bottom: none;
      background: transparent;
      color: var(--color-neutral-600);
      font-weight: 500;
      cursor: pointer;
      border-top-left-radius: var(--radius-md);
      border-top-right-radius: var(--radius-md);
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      top: 1px;
    }

    .hc-tab img {
      width: 16px;
      height: 16px;
    }

    .hc-tab--active {
      background: var(--color-surface);
      color: var(--color-text-strong);
      border-color: var(--color-border-subtle);
      box-shadow: 0 -1px 6px rgba(15, 23, 42, 0.08);
    }

    .hc-tab__close {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--color-neutral-500);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .hc-tab__close:hover {
      background: rgba(86, 102, 245, 0.12);
      color: var(--color-brand-600);
    }

    .hc-workspace {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border-subtle);
    }

    .hc-workspace__pane {
      position: absolute;
      inset: 0;
      border: none;
      width: 100%;
      height: 100%;
      display: none;
    }

    .hc-workspace__pane--active {
      display: block;
    }

    iframe.hc-workspace__pane {
      background: transparent;
    }

    .hc-empty-state,
    .hc-projects-state,
    .hc-loader-state,
    .hc-auth-card {
      margin: auto;
      max-width: 520px;
      padding: 48px;
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border-subtle);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 24px;
      text-align: center;
    }

    .hc-empty-state h2,
    .hc-projects-state h2,
    .hc-auth-card h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
    }

    .hc-empty-state p,
    .hc-projects-state p,
    .hc-auth-card p {
      margin: 0;
      color: var(--color-neutral-600);
      font-size: 1rem;
    }

    .hc-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    .hc-button--primary {
      background: linear-gradient(135deg, var(--color-brand-500), var(--color-brand-600));
      color: #ffffff;
      box-shadow: var(--shadow-sm);
    }

    .hc-button--primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .hc-button--secondary {
      background: rgba(86, 102, 245, 0.12);
      color: var(--color-brand-700);
    }

    .hc-button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .hc-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-subtle);
      font-size: 1rem;
      background: var(--color-neutral-50);
      color: var(--color-text-strong);
    }

    .hc-input:focus {
      outline: 3px solid var(--focus-ring-color);
      border-color: var(--color-brand-500);
    }

    .hc-projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      width: 100%;
    }

    .hc-project-card {
      background: linear-gradient(160deg, rgba(86,102,245,0.18), rgba(86,102,245,0.08));
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid rgba(86, 102, 245, 0.25);
      color: var(--color-text-strong);
      text-align: left;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hc-project-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .hc-project-card__name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .hc-project-card__meta {
      font-size: 0.85rem;
      color: var(--color-neutral-600);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hc-inline-loader {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid rgba(86, 102, 245, 0.35);
      border-top-color: rgba(86, 102, 245, 0.9);
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .hc-loader-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .hc-login-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 960px) {
      .hc-shell {
        flex-direction: column;
      }
      .hc-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      .hc-main__header {
        flex-direction: column;
        align-items: flex-start;
      }
      .hc-tabs {
        padding-inline: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="user === 'loading'" class="hc-loader-state">
      <div class="hc-loader-block">
        <div class="hc-inline-loader"></div>
        <p>Preparando tu espacio de trabajo...</p>
      </div>
    </div>

    <div v-else-if="user === null" class="hc-auth-card">
      <img src="img/logo.png" alt="hola.cloud" style="height: 48px; margin: 0 auto;">
      <h1>Bienvenido a hola.cloud</h1>
      <p>Administra tus recursos, bases de datos y funciones desde una consola moderna inspirada en un IDE profesional.</p>
      <div class="hc-login-actions">
        <a class="hc-button hc-button--primary" href="https://hola.cloud/auth/login">Iniciar sesión</a>
      </div>
    </div>

    <div v-else class="hc-shell">
      <aside class="hc-sidebar" :class="{ 'hc-sidebar--expanded': tricks.showtree }">
        <div class="hc-sidebar__inner">
          <div class="hc-sidebar__header">
            <div class="hc-brand">
              <img src="img/logo-short.png" alt="hola.cloud">
              <span class="hc-brand__text">hola.cloud Console</span>
            </div>
            <div class="hc-user-card">
              <img :src="user.picture" alt="Avatar del usuario">
              <div class="hc-user-card__meta">
                <span class="hc-user-name">{{ user.nick }}</span>
                <div class="hc-user-actions">
                  <a href="/auth/logout">Cerrar sesión</a>
                </div>
              </div>
            </div>
          </div>

          <div class="hc-sidebar__section">
            <span class="hc-section-title">Proyecto activo</span>
            <div class="hc-select" v-if="projects.length">
              <select v-model="project_id" @change="handleProjectChange">
                <option disabled value="">Selecciona un proyecto</option>
                <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                <option value="__none">&lt;{{ user.nick }}&gt;</option>
              </select>
            </div>
            <div v-else>
              <p style="margin: 0; color: rgba(226,232,240,0.7); font-size: 0.9rem;">No hay proyectos aún. Crea uno para comenzar.</p>
            </div>
          </div>

          <div class="hc-sidebar__section" v-if="project">
            <div class="hc-section-title">Recursos</div>
            <div class="hc-tree">
              <div class="hc-tree-group">
                <div class="hc-tree-title">Bases de datos</div>
                <ul class="hc-tree-list">
                  <li v-for="database in tree.databases" :key="database.id">
                    <div class="hc-tree-item">
                      <div class="hc-tree-item__main">
                        <button class="hc-tree-toggle" :aria-expanded="database.open" @click.stop="expandDatabase(database)">
                          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path d="M7 5l6 5-6 5V5z"></path>
                          </svg>
                        </button>
                        <img src="img/icon-db.png" alt="BD" style="width: 16px; height: 16px; filter: brightness(1.2);">
                        <span class="hc-tree-item__label">{{ database.name }}</span>
                      </div>
                    </div>
                    <div class="hc-tree-children" v-if="database.open && database.collections">
                      <div
                        class="hc-tree-item"
                        v-for="collection in database.collections"
                        :key="collection.name"
                        @click="openCollection(database, collection)"
                      >
                        <div class="hc-tree-item__main" style="margin-left: 20px;">
                          <img src="https://inceptiondb.hola.cloud/v2/img/icon-collection.svg" alt="Colección" style="height: 16px; filter: contrast(0.9);">
                          <span class="hc-tree-item__label">{{ collection.name }}</span>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="hc-tree-group">
                <div class="hc-tree-title">Lambdas</div>
                <ul class="hc-tree-list">
                  <li v-for="lambda in tree.lambdas" :key="lambda.id">
                    <div class="hc-tree-item" @click="openLambda(lambda)">
                      <div class="hc-tree-item__main">
                        <img src="img/icon-lambda.png" alt="Lambda" style="width: 16px; height: 16px;">
                        <span class="hc-tree-item__label">{{ lambda.method }} {{ lambda.path }}</span>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="hc-sidebar__section" v-if="!project && projects.length">
            <p style="margin: 0; color: rgba(226,232,240,0.8); font-size: 0.9rem;">
              Selecciona un proyecto para explorar bases de datos, lambdas, archivos y configuración.
            </p>
          </div>
        </div>
      </aside>

      <main class="hc-main">
        <div class="hc-main__header">
          <div class="hc-main__breadcrumbs">
            <span>hola.cloud / consola</span>
            <strong v-if="project">{{ project.name }}</strong>
            <strong v-else>Selecciona un proyecto</strong>
          </div>
          <div v-if="isLoadingProjects" class="hc-inline-loader"></div>
        </div>

        <div class="hc-tabs" v-if="tabs.length">
          <button
            v-for="(t, index) in tabs"
            :key="t.id || index"
            class="hc-tab"
            :class="{ 'hc-tab--active': tab === index }"
            @click="tab = index"
          >
            <img :src="t.icon" :alt="t.name">
            <span>{{ t.name }}</span>
            <button
              v-if="t.hideClose !== true"
              class="hc-tab__close"
              type="button"
              @click.stop="closeTab(index)"
              aria-label="Cerrar pestaña"
            >
              ×
            </button>
          </button>
        </div>

        <section class="hc-workspace">
          <template v-if="!project">
            <div class="hc-projects-state" v-if="projects.length">
              <h2>Elige un proyecto para comenzar</h2>
              <p>Administra múltiples entornos con pestañas paralelas, como si fuera tu IDE favorito.</p>
              <div class="hc-projects-grid">
                <div
                  class="hc-project-card"
                  v-for="p in projects"
                  :key="p.id"
                  @click="selectProject(p)"
                >
                  <div class="hc-project-card__name">{{ p.name }}</div>
                  <div class="hc-project-card__meta">
                    <span>{{ p.id }}</span>
                    <span v-if="p.owners && p.owners.length > 1">{{ p.owners.length }} colaboradores</span>
                  </div>
                  <a v-if="p.host" :href="'https://'+p.host" target="_blank" rel="noopener" @click.stop>{{ p.host }}</a>
                </div>
              </div>
              <div>
                <button class="hc-button hc-button--secondary" @click="inputs.showNewProject = !inputs.showNewProject">
                  {{ inputs.showNewProject ? 'Ocultar formulario' : 'Nuevo proyecto' }}
                </button>
              </div>
              <form v-if="inputs.showNewProject" @submit.prevent="createProject" style="display: flex; flex-direction: column; gap: 16px; width: 100%;">
                <input class="hc-input" type="text" placeholder="Nombre del proyecto" v-model="inputs.name" autofocus>
                <button class="hc-button hc-button--primary" type="submit" :disabled="!inputs.name">Crear proyecto</button>
              </form>
            </div>
            <div class="hc-empty-state" v-else>
              <h2>Crea tu primer proyecto</h2>
              <p>Define un nombre y habilita recursos para comenzar a construir en hola.cloud.</p>
              <form @submit.prevent="createProject" style="display: flex; flex-direction: column; gap: 16px;">
                <input class="hc-input" type="text" placeholder="Nombre del proyecto" v-model="inputs.name" required>
                <button class="hc-button hc-button--primary" type="submit" :disabled="!inputs.name">Crear proyecto</button>
              </form>
            </div>
          </template>

          <template v-else>
            <iframe
              v-for="(t, index) in tabs"
              :key="t.id || index"
              class="hc-workspace__pane"
              :class="{ 'hc-workspace__pane--active': tab === index }"
              :src="t.url"
            ></iframe>
          </template>
        </section>
      </main>
    </div>
  </div>

  <script>
    const localdev = document.location.hostname === 'localhost';
    const fakeHeaders = {};
    if (localdev) {
      fakeHeaders['X-Glue-Authentication'] = '{"user":{"id":"user1"}}';
    }

    let base = '';
    let baseprojects = 'https://projects.hola.cloud';
    let baseinception = 'https://inceptiondb.hola.cloud';
    let baselambdas = 'https://lambda.hola.cloud';
    if (localdev) {
      baseprojects = '/fakeapi/projectsapi';
      baseinception = '/fakeapi/inceptionapi';
      baselambdas = '/fakeapi/lambdasapi';
      base = '/fakeapi/authapi';
    }

    function compare(a, b) {
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function createBaseTabs(projectId) {
      const suffix = projectId ? projectId : '';
      return [
        {
          id: 'database',
          icon: 'img/icon-db.png',
          name: 'Database',
          url: `https://inceptiondb.hola.cloud/?embed&project=${suffix}`,
          hideClose: true,
        },
        {
          id: 'lambda',
          icon: 'img/icon-lambda.png',
          name: 'Lambda',
          url: `https://lambda.hola.cloud/?embed&project=${suffix}`,
          hideClose: true,
        },
        {
          id: 'config',
          icon: 'img/icon-config.png',
          name: 'Config',
          url: `https://config.hola.cloud/?embed&project=${suffix}`,
          hideClose: true,
        },
        {
          id: 'files',
          icon: 'img/icon-files.png',
          name: 'Files',
          url: `https://files.hola.cloud/?embed&project=${suffix}`,
          hideClose: true,
        },
      ];
    }

    const app = Vue.createApp({
      data() {
        return {
          projects: [],
          project: null,
          project_id: '',
          user: 'loading',
          loading: {
            fetch: 0,
          },
          inputs: {
            name: '',
            showNewProject: false,
          },
          tabs: createBaseTabs(''),
          tab: 0,
          tree: {
            databases: [],
            lambdas: [],
          },
          tricks: {
            showtree: false,
          },
        };
      },
      computed: {
        isLoadingProjects() {
          return this.loading.fetch > 0;
        },
      },
      created() {
        this.fetchProjects();

        fetch(base + '/auth/me')
          .then((resp) => resp.json())
          .then((user) => {
            if (user.error) {
              this.user = null;
              return;
            }
            this.user = user;
            if (localdev) {
              fakeHeaders['X-Glue-Authentication'] = JSON.stringify({ user });
            }
            this.fetchProjects();
            if (this.project_id) {
              this.fetchTree();
            }
          })
          .catch(() => {
            this.user = null;
          });

        let letters = '';
        document.addEventListener(
          'keyup',
          (e) => {
            letters += e.key;
            if (letters.length > 20) {
              letters = letters.substring(letters.length - 20);
            }
            if (letters.endsWith('showtree')) {
              this.tricks.showtree = !this.tricks.showtree;
            }
          },
          true,
        );
      },
      methods: {
        handleProjectChange(event) {
          const value = event.target.value;
          if (!value || value === '__none') {
            this.project = null;
            this.project_id = '';
            delete fakeHeaders['X-Project'];
            this.tabs = createBaseTabs('');
            this.tab = 0;
            this.tree.databases = [];
            this.tree.lambdas = [];
            return;
          }
          const selected = this.projects.find((p) => p.id === value);
          if (selected) {
            this.selectProject(selected);
          }
        },
        selectProject(project) {
          this.project = project;
          this.project_id = project.id;
          if (localdev) {
            fakeHeaders['X-Project'] = project.id;
          } else {
            fakeHeaders['X-Project'] = project.id;
          }
          this.tabs = createBaseTabs(project.id);
          this.tab = 0;
          this.fetchTree();
        },
        fetchTree() {
          if (!this.project_id) {
            return;
          }
          fakeHeaders['X-Project'] = this.project_id;
          this.fetchDatabases();
          this.fetchLambdas();
        },
        fetchProjects() {
          this.loading.fetch++;
          fetch(baseprojects + '/v0/projects', { headers: {}, credentials: 'include' })
            .then((resp) => resp.json())
            .then((values) => {
              this.projects = values.sort((a, b) => compare(a.name, b.name));
              if (this.project_id) {
                const match = this.projects.find((p) => p.id === this.project_id);
                if (match && (!this.project || this.project.id !== match.id)) {
                  this.selectProject(match);
                }
                if (!match) {
                  this.project = null;
                  this.project_id = '';
                  this.tabs = createBaseTabs('');
                }
              }
            })
            .catch(() => {})
            .finally(() => {
              this.loading.fetch = Math.max(0, this.loading.fetch - 1);
            });
        },
        fetchDatabases() {
          if (!this.project_id) return;
          fetch(baseinception + '/v1/databases', {
            headers: fakeHeaders,
            credentials: 'include',
          })
            .then((resp) => resp.json())
            .then((values) => {
              values.forEach((db) => {
                db.collections = [];
                db.open = false;
              });
              values.sort((a, b) => compare(a.name, b.name));
              this.tree.databases = values;
            })
            .catch(() => {});
        },
        fetchLambdas() {
          if (!this.project_id) return;
          fetch(baselambdas + '/api/v0/lambdas', {
            headers: fakeHeaders,
            credentials: 'include',
          })
            .then((resp) => resp.json())
            .then((values) => {
              values.sort((a, b) => compare(a.path + ' ' + a.method, b.path + ' ' + b.method));
              this.tree.lambdas = values;
            })
            .catch(() => {});
        },
        expandDatabase(db) {
          db.open = !db.open;
          if (!db.open) return;
          fetch(baseinception + `/v1/databases/${db.id}/collections`, {
            headers: fakeHeaders,
            credentials: 'include',
          })
            .then((resp) => resp.json())
            .then((values) => {
              db.collections = values;
            })
            .catch(() => {});
        },
        closeTab(index) {
          this.tabs.splice(index, 1);
          if (this.tab >= this.tabs.length) {
            this.tab = Math.max(0, this.tabs.length - 1);
          }
        },
        openLambda(lambda) {
          const url = `https://lambda.hola.cloud/?embed&project=${this.project_id}#/lambdas/${lambda.id}`;
          const existingIndex = this.tabs.findIndex((tab) => tab.url === url);
          if (existingIndex >= 0) {
            this.tab = existingIndex;
            return;
          }
          this.tabs.push({
            id: `lambda-${lambda.id}`,
            icon: 'img/icon-lambda.png',
            name: `${lambda.method} ${lambda.path}`,
            url,
          });
          this.tab = this.tabs.length - 1;
        },
        openCollection(database, collection) {
          const url = `https://inceptiondb.hola.cloud/?embed&project=${this.project_id}#/databases/${database.id}/collections/${collection.name}`;
          const existingIndex = this.tabs.findIndex((tab) => tab.url === url);
          if (existingIndex >= 0) {
            this.tab = existingIndex;
            return;
          }
          this.tabs.push({
            id: `collection-${database.id}-${collection.name}`,
            icon: 'img/icon-db.png',
            name: collection.name,
            url,
          });
          this.tab = this.tabs.length - 1;
        },
        createProject() {
          if (!this.inputs.name) return;
          const body = {
            name: this.inputs.name,
          };
          return fetch(baseprojects + '/v0/projects', {
            method: 'POST',
            headers: {},
            credentials: 'include',
            body: JSON.stringify(body),
          })
            .then((resp) => resp.json())
            .then((project) => {
              this.inputs.name = '';
              this.inputs.showNewProject = false;
              this.projects.push(project);
              this.projects.sort((a, b) => compare(a.name, b.name));
              this.selectProject(project);
            });
        },
      },
    });

    app.mount('#app');
  </script>
</body>
</html>
